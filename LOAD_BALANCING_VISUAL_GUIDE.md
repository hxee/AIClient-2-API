# è´Ÿè½½å‡è¡¡å’Œæ¨¡å‹åˆ—è¡¨è·å– - å¯è§†åŒ–æŒ‡å—

## ğŸ“Š ç³»ç»Ÿé…ç½®ç¤ºä¾‹

å‡è®¾ä½ çš„ `provider_pools.json` é…ç½®å¦‚ä¸‹ï¼š

```json
{
  "openai-custom": [
    {
      "uuid": "provider-001",
      "OPENAI_API_KEY": "sk-proj-key1xxxxx",
      "OPENAI_BASE_URL": "https://api.openai.com/v1",
      "isHealthy": true,
      "isDisabled": false,
      "usageCount": 0,
      "errorCount": 0
    },
    {
      "uuid": "provider-002",
      "OPENAI_API_KEY": "sk-proj-key2yyyyy",
      "OPENAI_BASE_URL": "https://api.openai.com/v1",
      "isHealthy": true,
      "isDisabled": false,
      "usageCount": 0,
      "errorCount": 0
    },
    {
      "uuid": "provider-003",
      "OPENAI_API_KEY": "sk-proj-key3zzzzz",
      "OPENAI_BASE_URL": "https://api.openai.com/v1",
      "isHealthy": true,
      "isDisabled": false,
      "usageCount": 0,
      "errorCount": 0
    }
  ]
}
```

---

## ğŸ” åœºæ™¯ 1ï¼šè·å–æ¨¡å‹åˆ—è¡¨ GET /v1/models

### å½“å‰è¡Œä¸ºï¼ˆâŒ åªä½¿ç”¨ç¬¬ä¸€ä¸ªä¾›åº”å•†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯: GET /v1/models                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  handleModelListRequest()    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ éå† providerPools â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ‰¾åˆ° openai-custom çš„æ‰€æœ‰ä¾›åº”å•†:     â”‚
        â”‚ [provider-001, provider-002, provider-003] â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç­›é€‰å¥åº·ä¸”å¯ç”¨çš„ä¾›åº”å•†  â”‚
    â”‚ [provider-001, provider-002, provider-003] â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âŒ åªå–ç¬¬ä¸€ä¸ª: provider-001   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ä½¿ç”¨ provider-001 çš„ sk-proj-key1xxxxx   â”‚
    â”‚ è°ƒç”¨ OpenAI API â†’ /models                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è¿”å› provider-001 çš„æ¨¡å‹åˆ—è¡¨:     â”‚
    â”‚ [gpt-4, gpt-4-turbo, gpt-3.5]   â”‚
    â”‚                                   â”‚
    â”‚ âŒ é—®é¢˜: provider-002 å’Œ 003     â”‚
    â”‚    çš„æ¨¡å‹æœªè¢«è·å–                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    è¿”å›ç»™å®¢æˆ·ç«¯:
    {
      "object": "list",
      "data": [
        { "id": "[OpenAI] gpt-4", ... },
        { "id": "[OpenAI] gpt-4-turbo", ... },
        { "id": "[OpenAI] gpt-3.5-turbo", ... }
      ]
    }
```

### æ”¹è¿›å»ºè®®ï¼ˆâœ… è·å–æ‰€æœ‰ä¾›åº”å•†çš„æ¨¡å‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯: GET /v1/models                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  handleModelListRequest()    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ éå† providerPools â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ‰¾åˆ° openai-custom çš„æ‰€æœ‰ä¾›åº”å•†:     â”‚
        â”‚ [provider-001, provider-002, provider-003] â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç­›é€‰å¥åº·ä¸”å¯ç”¨çš„ä¾›åº”å•†  â”‚
    â”‚ [provider-001, provider-002, provider-003] â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ… éå†æ‰€æœ‰å¥åº·ä¾›åº”å•†:                â”‚
    â”‚                                        â”‚
    â”‚ å¹¶è¡Œè°ƒç”¨:                              â”‚
    â”‚  â”œâ”€ provider-001 â†’ models list 1      â”‚
    â”‚  â”œâ”€ provider-002 â†’ models list 2      â”‚
    â”‚  â””â”€ provider-003 â†’ models list 3      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å»é‡å¹¶åˆå¹¶æ¨¡å‹åˆ—è¡¨                    â”‚
    â”‚                                        â”‚
    â”‚ List 1: [gpt-4, gpt-4-turbo, ...]    â”‚
    â”‚ List 2: [gpt-4, model-A, model-B]    â”‚
    â”‚ List 3: [gpt-4, model-C]             â”‚
    â”‚                                        â”‚
    â”‚ ç»“æœ: [gpt-4, gpt-4-turbo, model-A,  â”‚
    â”‚       model-B, model-C, ...]         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    è¿”å›ç»™å®¢æˆ·ç«¯:
    {
      "object": "list",
      "data": [
        { "id": "[OpenAI] gpt-4", "provider": "provider-001,002,003" },
        { "id": "[OpenAI] gpt-4-turbo", ... },
        { "id": "[OpenAI] model-A", "provider": "provider-002" },
        { "id": "[OpenAI] model-B", "provider": "provider-002" },
        { "id": "[OpenAI] model-C", "provider": "provider-003" }
      ]
    }
```

---

## ğŸ”„ åœºæ™¯ 2ï¼šå¤„ç† API è¯·æ±‚ï¼ˆè½®è¯¢è´Ÿè½½å‡è¡¡ï¼‰

### âœ… å½“å‰è¡Œä¸ºï¼ˆæ­£ç¡®å®ç°ï¼‰

å‡è®¾è¿ç»­å‘æ¥ 6 ä¸ª chat completion è¯·æ±‚ï¼š

```
åˆå§‹çŠ¶æ€:
roundRobinIndex[openai-custom] = 0
provider-001: usageCount = 0
provider-002: usageCount = 0
provider-003: usageCount = 0

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ 1: POST /v1/chat/completions (model: "gpt-4")
        â”‚
        â”œâ”€ selectProvider("openai-custom")
        â”‚  â””â”€ index = 0 % 3 = 0 â†’ é€‰æ‹© provider-001
        â”‚  â””â”€ roundRobinIndex æ›´æ–°: 0 + 1 = 1
        â”‚
        â””â”€ è°ƒç”¨: provider-001 (sk-proj-key1xxxxx)
           
ç»“æœ: æˆåŠŸ âœ…
      provider-001: usageCount = 1
      provider-002: usageCount = 0
      provider-003: usageCount = 0
      roundRobinIndex = 1

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ 2: POST /v1/chat/completions (model: "gpt-4")
        â”‚
        â”œâ”€ selectProvider("openai-custom")
        â”‚  â””â”€ index = 1 % 3 = 1 â†’ é€‰æ‹© provider-002
        â”‚  â””â”€ roundRobinIndex æ›´æ–°: 1 + 1 = 2
        â”‚
        â””â”€ è°ƒç”¨: provider-002 (sk-proj-key2yyyyy)

ç»“æœ: æˆåŠŸ âœ…
      provider-001: usageCount = 1
      provider-002: usageCount = 1
      provider-003: usageCount = 0
      roundRobinIndex = 2

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ 3: POST /v1/chat/completions (model: "gpt-4")
        â”‚
        â”œâ”€ selectProvider("openai-custom")
        â”‚  â””â”€ index = 2 % 3 = 2 â†’ é€‰æ‹© provider-003
        â”‚  â””â”€ roundRobinIndex æ›´æ–°: 2 + 1 = 3
        â”‚
        â””â”€ è°ƒç”¨: provider-003 (sk-proj-key3zzzzz)

ç»“æœ: æˆåŠŸ âœ…
      provider-001: usageCount = 1
      provider-002: usageCount = 1
      provider-003: usageCount = 1
      roundRobinIndex = 3

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ 4: POST /v1/chat/completions (model: "gpt-4")
        â”‚
        â”œâ”€ selectProvider("openai-custom")
        â”‚  â””â”€ index = 3 % 3 = 0 â†’ é€‰æ‹© provider-001 (è½®å›)
        â”‚  â””â”€ roundRobinIndex æ›´æ–°: 3 + 1 = 4
        â”‚
        â””â”€ è°ƒç”¨: provider-001 (sk-proj-key1xxxxx)

ç»“æœ: å¤±è´¥ âŒ (API é…é¢è¶…é™)
      markProviderUnhealthy("openai-custom", provider-001)
      provider-001: errorCount = 1, isHealthy = true (è¿˜æœªè¾¾åˆ°é˜ˆå€¼)
      provider-002: usageCount = 1
      provider-003: usageCount = 1
      roundRobinIndex = 4

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ 5: POST /v1/chat/completions (model: "gpt-4")
        â”‚
        â”œâ”€ selectProvider("openai-custom")
        â”‚  â””â”€ index = 4 % 3 = 1 â†’ é€‰æ‹© provider-002
        â”‚  â””â”€ roundRobinIndex æ›´æ–°: 4 + 1 = 5
        â”‚
        â””â”€ è°ƒç”¨: provider-002 (sk-proj-key2yyyyy)

ç»“æœ: æˆåŠŸ âœ…
      provider-001: errorCount = 1, usageCount = 1
      provider-002: usageCount = 2
      provider-003: usageCount = 1
      roundRobinIndex = 5

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ 6: POST /v1/chat/completions (model: "gpt-4")
        â”‚
        â”œâ”€ selectProvider("openai-custom")
        â”‚  â””â”€ index = 5 % 3 = 2 â†’ é€‰æ‹© provider-003
        â”‚  â””â”€ roundRobinIndex æ›´æ–°: 5 + 1 = 6
        â”‚
        â””â”€ è°ƒç”¨: provider-003 (sk-proj-key3zzzzz)

ç»“æœ: æˆåŠŸ âœ…
      provider-001: errorCount = 1, usageCount = 1
      provider-002: usageCount = 2
      provider-003: usageCount = 2
      roundRobinIndex = 6

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æœ€ç»ˆç»Ÿè®¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¾›åº”å•†         â”‚ usageCount â”‚ errorCount    â”‚ çŠ¶æ€            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ provider-001   â”‚ 1          â”‚ 1             â”‚ å¥åº· âœ… (é”™è¯¯æ•°<é˜ˆå€¼)â”‚
â”‚ provider-002   â”‚ 2          â”‚ 0             â”‚ å¥åº· âœ…         â”‚
â”‚ provider-003   â”‚ 2          â”‚ 0             â”‚ å¥åº· âœ…         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è½®è¯¢è½¨è¿¹:
è¯·æ±‚1 â†’ provider-001 (0)
è¯·æ±‚2 â†’ provider-002 (1)
è¯·æ±‚3 â†’ provider-003 (2)
è¯·æ±‚4 â†’ provider-001 (0)
è¯·æ±‚5 â†’ provider-002 (1)
è¯·æ±‚6 â†’ provider-003 (2)

è´Ÿè½½åˆ†é…: ç›¸å¯¹å‡è¡¡ (1, 2, 2)
```

---

## âš ï¸ åœºæ™¯ 3ï¼šä¾›åº”å•†æ•…éšœæ¢å¤

### å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤

```
æ—¶é—´çº¿:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

T0: åˆå§‹çŠ¶æ€
    provider-001: isHealthy = true, errorCount = 0
    provider-002: isHealthy = true, errorCount = 0
    provider-003: isHealthy = true, errorCount = 0

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

T1: provider-001 è¿ç»­å‡ºç°3ä¸ªé”™è¯¯
    é”™è¯¯1: provider-001 â†’ errorCount = 1
    é”™è¯¯2: provider-001 â†’ errorCount = 2
    é”™è¯¯3: provider-001 â†’ errorCount = 3 (è¾¾åˆ°é˜ˆå€¼)
           markProviderUnhealthy() è§¦å‘
           isHealthy = false âŒ

ç»“æœ: provider-001 è¢«æ’é™¤å‡ºè½®è¯¢

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

T2: è¯·æ±‚ 4, 5, 6 ç»§ç»­åˆ°è¾¾
    selectProvider() ç°åœ¨åªèƒ½ä» [provider-002, provider-003] ä¸­é€‰æ‹©
    
    è¯·æ±‚4 â†’ 0 % 2 = 0 â†’ provider-002
    è¯·æ±‚5 â†’ 1 % 2 = 1 â†’ provider-003
    è¯·æ±‚6 â†’ 2 % 2 = 0 â†’ provider-002
    
    è½®è¯¢åœ¨å‰©ä½™ä¾›åº”å•†é—´ç»§ç»­

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

T3: å®šæœŸå¥åº·æ£€æŸ¥è§¦å‘ (é»˜è®¤10åˆ†é’Ÿ)
    performHealthChecks() å¯¹æ‰€æœ‰ä¾›åº”å•†è¿›è¡Œæ£€æŸ¥
    
    provider-001 çš„æ£€æŸ¥:
    â”œâ”€ æœ€åé”™è¯¯æ—¶é—´: T1
    â”œâ”€ å½“å‰æ—¶é—´: T3 (> 10åˆ†é’Ÿ)
    â”œâ”€ å‘é€æµ‹è¯•è¯·æ±‚ â†’ æˆåŠŸ âœ…
    â”‚
    â””â”€ æ ‡è®°ä¸ºå¥åº·: isHealthy = true
       errorCount = 0 (é‡ç½®)
       lastErrorTime = null

ç»“æœ: provider-001 é‡æ–°åŠ å…¥è½®è¯¢

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

T4: åç»­è¯·æ±‚
    selectProvider() ç°åœ¨å¯ä»¥ä» [provider-001, provider-002, provider-003] é€‰æ‹©
    
    è¯·æ±‚7 â†’ 6 % 3 = 0 â†’ provider-001 (æ¢å¤ä½¿ç”¨) âœ…
    è¯·æ±‚8 â†’ 7 % 3 = 1 â†’ provider-002
    è¯·æ±‚9 â†’ 8 % 3 = 2 â†’ provider-003

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ“ ä»£ç å…³é”®é…ç½®

### ProviderPoolManager åˆå§‹åŒ–å‚æ•°

```javascript
const poolManager = new ProviderPoolManager(providerPools, {
    maxErrorCount: 3,              // è¾¾åˆ°3ä¸ªé”™è¯¯åæ ‡è®°ä¸ºä¸å¥åº·
    healthCheckInterval: 10 * 60 * 1000,  // 10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä¸å¥åº·ä¾›åº”å•†
    saveDebounceTime: 1000         // é˜²æŠ–1ç§’ï¼Œé¿å…é¢‘ç¹å†™æ–‡ä»¶
});
```

### selectProvider ä¼˜å…ˆçº§é€»è¾‘

```javascript
selectProvider(providerType, preferredUuid = null)
â”‚
â”œâ”€ Step 1: ç­›é€‰æ‰€æœ‰å¥åº·ä¸”å¯ç”¨çš„ä¾›åº”å•†
â”‚  â””â”€ filter(p => p.isHealthy && !p.isDisabled)
â”‚
â”œâ”€ Step 2: å¦‚æœæŒ‡å®šäº†åå¥½çš„ UUIDï¼Œä½¿ç”¨æŒ‡å®šçš„
â”‚  â””â”€ if (preferredUuid) â†’ return preferredProvider
â”‚
â””â”€ Step 3: å¦åˆ™ä½¿ç”¨è½®è¯¢
   â”œâ”€ currentIndex = roundRobinIndex[providerType]
   â”œâ”€ providerIndex = currentIndex % availableCount
   â”œâ”€ selected = availableProviders[providerIndex]
   â””â”€ roundRobinIndex[providerType]++ (å¾ªç¯)
```

---

## ğŸ¯ æ€»ç»“å¯¹æ¯”

| ç‰¹æ€§ | æ¨¡å‹åˆ—è¡¨è¯·æ±‚ | API è¯·æ±‚ |
|------|------------|---------|
| **ä½¿ç”¨ä¾›åº”å•†æ•°é‡** | 1ï¼ˆâŒ åªæœ‰ç¬¬ä¸€ä¸ªï¼‰ | å¤šä¸ªï¼ˆâœ… è½®è¯¢ï¼‰ |
| **åˆ†å¸ƒç­–ç•¥** | æ—  | è½®è¯¢ (Round-Robin) |
| **æ•…éšœè½¬ç§»** | æ—  | æœ‰ï¼ˆè‡ªåŠ¨æ’é™¤å¤±è´¥çš„ï¼‰ |
| **æ¢å¤æœºåˆ¶** | æ—  | æœ‰ï¼ˆå®šæœŸå¥åº·æ£€æŸ¥ï¼‰ |
| **è´Ÿè½½å‡è¡¡** | æ—  | æœ‰ï¼ˆç›¸å¯¹å‡è¡¡ï¼‰ |
| **å¯è§æ€§** | ä½ | é«˜ |

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. å¤šä¾›åº”å•†é…ç½®

```json
{
  "openai-custom": [
    {
      "uuid": "primary-key",
      "OPENAI_API_KEY": "sk-proj-xxxxx",
      "checkHealth": true
    },
    {
      "uuid": "backup-key",
      "OPENAI_API_KEY": "sk-proj-yyyyy",
      "checkHealth": true
    }
  ]
}
```

### 2. ç›‘æ§è½®è¯¢æ•ˆæœ

é€šè¿‡ WebUI æŸ¥çœ‹æ¯ä¸ªä¾›åº”å•†çš„ï¼š
- `usageCount` - ä½¿ç”¨æ¬¡æ•°ï¼ˆæŒ‡æ ‡ï¼šåº”è¯¥ç›¸å¯¹å‡è¡¡ï¼‰
- `errorCount` - é”™è¯¯æ¬¡æ•°ï¼ˆæŒ‡æ ‡ï¼šåº”è¯¥ä¸º0æˆ–å¾ˆä½ï¼‰
- `lastUsed` - æœ€åä½¿ç”¨æ—¶é—´ï¼ˆæŒ‡æ ‡ï¼šåº”è¯¥æœ€è¿‘ï¼‰

### 3. æ¨¡å‹åˆ—è¡¨è·å–

**å½“å‰**ï¼šå®¢æˆ·ç«¯åªçœ‹åˆ°ç¬¬ä¸€ä¸ªä¾›åº”å•†çš„æ¨¡å‹
**å»ºè®®**ï¼šåœ¨ WebUI ä¸­å®ç°"åˆå¹¶è§†å›¾"ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹
